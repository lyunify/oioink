{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ title|default:"Add Spending" }}</h4>
                </div>
                <div class="card-body">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                            {{ form.date }}
                            {% if form.date.errors %}
                            <div class="text-danger small">{{ form.date.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.amount }}
                            </div>
                            {% if form.amount.errors %}
                            <div class="text-danger small">{{ form.amount.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3" id="category_select_div">
                            <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                            {{ form.category }}
                            {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3" id="custom_category_div" style="display: none;">
                            <label for="{{ form.custom_category_name.id_for_label }}" class="form-label">{{ form.custom_category_name.label }}</label>
                            {{ form.custom_category_name }}
                            {% if form.custom_category_name.errors %}
                            <div class="text-danger small">{{ form.custom_category_name.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Enter a custom category name</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.child_name.id_for_label }}" class="form-label">{{ form.child_name.label }}</label>
                            {{ form.child_name }}
                            {% if form.child_name.errors %}
                            <div class="text-danger small">{{ form.child_name.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Optional: Enter the child's name for this spending</small>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'tracking:spending_list' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('id_category');
    const categorySelectDiv = document.getElementById('category_select_div');
    const customCategoryDiv = document.getElementById('custom_category_div');
    const customCategoryInput = document.getElementById('id_custom_category_name');
    
    // Default category list
    const defaultCategories = ['Clothing', 'Video', 'Electronics', 'School Supplies', 'Games', 
                              'Food', 'Transportation', 'Sports', 'Gifts', 'Other'];
    
    function isDefaultCategory(categoryText) {
        // Remove icon, keep only category name (format might be "ðŸ“¦ Other" or "Other")
        const categoryName = categoryText.replace(/^[^\w\s]+/, '').trim();
        return defaultCategories.includes(categoryName);
    }
    
    function toggleCustomCategory() {
        if (!categorySelect || !customCategoryDiv || !categorySelectDiv) return;
        
        // Check if custom input has value (when editing custom category)
        const hasCustomCategoryValue = customCategoryInput && customCategoryInput.value.trim() !== '';
        
        // If custom input has value (edit mode), hide dropdown, show input
        if (hasCustomCategoryValue) {
            categorySelectDiv.style.display = 'none';
            customCategoryDiv.style.display = 'block';
            categorySelect.value = ''; // Clear category selection
            if (customCategoryInput) {
                customCategoryInput.required = true;
            }
            return;
        }
        
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        if (!selectedOption || categorySelect.value === '') {
            // If no option selected, show dropdown
            categorySelectDiv.style.display = 'block';
            customCategoryDiv.style.display = 'none';
            return;
        }
        
        // Get option text (might include icon, e.g., "ðŸ“¦ Other")
        const categoryText = selectedOption.text.trim();
        
        // Check if is default category
        const isDefault = isDefaultCategory(categoryText);
        
        // Check if "Other" category is selected
        const isOtherCategory = categoryText === 'Other' || 
                                categoryText.endsWith('Other') || 
                                categoryText.includes(' Other');
        
        // If not default category (means it's custom), or "Other" is selected
        if (!isDefault || isOtherCategory) {
            // Hide dropdown, show custom input, clear category selection
            categorySelectDiv.style.display = 'none';
            customCategoryDiv.style.display = 'block';
            categorySelect.value = ''; // Clear category selection
            if (customCategoryInput) {
                customCategoryInput.required = true;
                if (isOtherCategory) {
                    customCategoryInput.focus(); // Auto focus on input
                }
            }
        } else {
            // When selecting other default category: show dropdown, hide custom input
            categorySelectDiv.style.display = 'block';
            customCategoryDiv.style.display = 'none';
            if (customCategoryInput) {
                customCategoryInput.required = false;
                customCategoryInput.value = '';
            }
        }
    }
    
    // Initial check
    toggleCustomCategory();
    
    // Listen for custom input changes, if user clears input, restore dropdown
    if (customCategoryInput) {
        customCategoryInput.addEventListener('input', function() {
            if (this.value.trim() === '' && categorySelect.value === '') {
                categorySelectDiv.style.display = 'block';
                customCategoryDiv.style.display = 'none';
                customCategoryInput.required = false;
            }
        });
    }
    
    // Listen for category selection changes
    if (categorySelect) {
        categorySelect.addEventListener('change', toggleCustomCategory);
    }
});
</script>
{% endblock scripts %}

